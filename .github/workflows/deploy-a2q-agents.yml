name: Execute NRQL Query

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  execute-query:
    name: Execute NRQL Query
    runs-on: ubuntu-22.04

    env:
      NR_API_KEY: ${{ secrets.A2Q_NR1_API_KEY }}
      ACCOUNT_ID: ${{ secrets.A2Q_NR1_ACCOUNT_ID }}
      NRQL_QUERY: "SELECT sum(if(WHERE totalEvaluations > 0 AND `successfulAssertions` > 0, 1, 0)) AS 'Failed tests' FROM A2QTestResult WHERE a2q.environment = 'production' AND apiVersion IN ('v1') AND `a2q.executor.name` = 'nri-k8s' AND `x-ghBranch` = 'master' FACET testName"

    steps:
      - name: Execute NRQL Query
        run: |
          echo "Executing NRQL query against account: $ACCOUNT_ID"
          echo ""
          echo "Query:"
          echo "$NRQL_QUERY"
          echo ""
          echo "Results:"

          # Execute NRQL query using New Relic GraphQL API
          RESPONSE=$(curl -s -X POST https://api.newrelic.com/graphql \
            -H "Content-Type: application/json" \
            -H "API-Key: $NR_API_KEY" \
            -d "{
              \"query\": \"{ actor { account(id: $ACCOUNT_ID) { nrql(query: \\\"$NRQL_QUERY\\\") { results } } } }\"
            }")

          echo "$RESPONSE" | jq '.'

      - name: Generate Query Summary
        if: always()
        run: |
          echo "## NRQL Query Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Account ID:** $ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Query" >> $GITHUB_STEP_SUMMARY
          echo '```sql' >> $GITHUB_STEP_SUMMARY
          echo "$NRQL_QUERY" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
