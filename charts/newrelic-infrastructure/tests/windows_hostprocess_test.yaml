suite: Windows HostProcess Mode
templates:
  - templates/kubelet/daemonset-windows.yaml
  - templates/kubelet/scraper-configmap.yaml
  - templates/kubelet/agent-configmap.yaml
  - templates/kubelet/integrations-configmap.yaml
  - templates/secret.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  # Privileged Mode (HostProcess enabled) Tests
  - it: should enable hostProcess for both containers in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.hostProcess
          value: true
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.hostProcess
          value: true
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set correct user accounts in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.runAsUserName
          value: "NT AUTHORITY\\Local service"
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.runAsUserName
          value: "NT AUTHORITY\\SYSTEM"
        template: templates/kubelet/daemonset-windows.yaml

  - it: should add PowerShell command with CONTAINER_SANDBOX_MOUNT_POINT for kubelet in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: "powershell.exe"
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[0].command[1]
          value: "-Command"
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[0].command[2]
          value: "& $env:CONTAINER_SANDBOX_MOUNT_POINT\\app\\nri-kubernetes.exe"
        template: templates/kubelet/daemonset-windows.yaml

  - it: should add PowerShell command with CONTAINER_SANDBOX_MOUNT_POINT for agent in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].command[0]
          value: "powershell.exe"
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].command[1]
          value: "-Command"
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].command[2]
          value: "$env:CONTAINER_SANDBOX_MOUNT_POINT\\start.ps1"
        template: templates/kubelet/daemonset-windows.yaml

  - it: should enable hostNetwork in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: spec.template.spec.hostNetwork
          value: true
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set privileged mode labels in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - equal:
          path: metadata.labels.mode
          value: privileged
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.metadata.labels.mode
          value: privileged
        template: templates/kubelet/daemonset-windows.yaml

  - it: should not set NRIA_OVERRIDE_HOST_ROOT in privileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - notContains:
          path: spec.template.spec.containers[1].env
          content:
            name: NRIA_OVERRIDE_HOST_ROOT
        template: templates/kubelet/daemonset-windows.yaml

  - it: should not set NRIA_HOST in privileged mode (uses hostNetwork)
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
    asserts:
      - notContains:
          path: spec.template.spec.containers[1].env
          content:
            name: NRIA_HOST
        template: templates/kubelet/daemonset-windows.yaml

  # Unprivileged Mode (HostProcess disabled) Tests
  - it: should disable hostProcess for both containers in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.hostProcess
          value: false
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.hostProcess
          value: false
        template: templates/kubelet/daemonset-windows.yaml

  - it: should use ContainerUser for both containers in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.runAsUserName
          value: ContainerUser
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.runAsUserName
          value: ContainerUser
        template: templates/kubelet/daemonset-windows.yaml

  - it: should not add command override for kubelet container in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].command
        template: templates/kubelet/daemonset-windows.yaml

  - it: should not add command override for agent container in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[1].command
        template: templates/kubelet/daemonset-windows.yaml

  - it: should not enable hostNetwork in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - isNull:
          path: spec.template.spec.hostNetwork
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set unprivileged mode labels in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - equal:
          path: metadata.labels.mode
          value: unprivileged
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.metadata.labels.mode
          value: unprivileged
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set NRIA_OVERRIDE_HOST_ROOT to empty in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - contains:
          path: spec.template.spec.containers[1].env
          content:
            name: NRIA_OVERRIDE_HOST_ROOT
            value: ""
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set NRIA_HOST for autodiscovery in unprivileged mode
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
    asserts:
      - contains:
          path: spec.template.spec.containers[1].env
          content:
            name: NRIA_HOST
            valueFrom:
              fieldRef:
                apiVersion: "v1"
                fieldPath: "status.hostIP"
        template: templates/kubelet/daemonset-windows.yaml

  # Windows-specific privileged override tests
  - it: should respect windows.privileged=false override when global privileged=true
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: true
      windows:
        privileged: false
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.hostProcess
          value: false
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.hostProcess
          value: false
        template: templates/kubelet/daemonset-windows.yaml
      - isNull:
          path: spec.template.spec.hostNetwork
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: metadata.labels.mode
          value: unprivileged
        template: templates/kubelet/daemonset-windows.yaml

  - it: should respect windows.privileged=true override when global privileged=false
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
      privileged: false
      windows:
        privileged: true
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.windowsOptions.hostProcess
          value: true
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].securityContext.windowsOptions.hostProcess
          value: true
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.hostNetwork
          value: true
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: metadata.labels.mode
          value: privileged
        template: templates/kubelet/daemonset-windows.yaml

  # Common tests
  - it: should set Windows OS spec
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
    asserts:
      - equal:
          path: spec.template.spec.os.name
          value: windows
        template: templates/kubelet/daemonset-windows.yaml

  - it: should set both container names correctly
    set:
      licenseKey: test
      cluster: test
      kubelet.enabled: true
      enableWindows: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: kubelet
        template: templates/kubelet/daemonset-windows.yaml
      - equal:
          path: spec.template.spec.containers[1].name
          value: agent
        template: templates/kubelet/daemonset-windows.yaml
