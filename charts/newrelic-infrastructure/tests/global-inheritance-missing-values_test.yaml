suite: Global Values Precedence Tests - Missing Values Coverage
templates:
  - templates/controlplane/daemonset.yaml
  - templates/controlplane/agent-configmap.yaml
  - templates/kubelet/daemonset.yaml
  - templates/kubelet/daemonset-windows.yaml
  - templates/kubelet/agent-configmap.yaml
  - templates/ksm/deployment.yaml
  - templates/ksm/agent-configmap.yaml
  - templates/secret.yaml

release:
  name: my-release
  namespace: my-namespace

tests:
  # =============================================================================
  # LICENSE KEY - Explicit Global Value Tests
  # =============================================================================
  - it: licenseKey - should inherit global.licenseKey when no local licenseKey is set
    set:
      cluster: test
      global:
        licenseKey: global-license-key-123
    asserts:
      - equal:
          path: data.license_key
          value: Z2xvYmFsLWxpY2Vuc2Uta2V5LTEyMw==  # base64 encoded "global-license-key-123"
        template: templates/secret.yaml

  - it: licenseKey - should use local licenseKey over global.licenseKey when both are set
    set:
      cluster: test
      licenseKey: local-license-key-456
      global:
        licenseKey: global-license-key-123
    asserts:
      - equal:
          path: data.license_key
          value: bG9jYWwtbGljZW5zZS1rZXktNDU2  # base64 encoded "local-license-key-456"
        template: templates/secret.yaml

  # =============================================================================
  # CUSTOM SECRET NAME - Explicit Global Value Tests
  # =============================================================================
  - it: customSecretName - should inherit global.customSecretName when no local customSecretName is set
    set:
      cluster: test
      global:
        customSecretName: my-global-secret
    asserts:
      - hasDocuments:
          count: 0
        template: templates/secret.yaml

  - it: customSecretName - should use local customSecretName over global.customSecretName when both are set
    set:
      cluster: test
      customSecretName: my-local-secret
      global:
        customSecretName: my-global-secret
    asserts:
      - hasDocuments:
          count: 0
        template: templates/secret.yaml

  # =============================================================================
  # CUSTOM SECRET LICENSE KEY - Explicit Global Value Tests
  # =============================================================================
  - it: customSecretLicenseKey - should inherit global.customSecretLicenseKey when no local customSecretLicenseKey is set
    set:
      cluster: test
      licenseKey: test-key
      global:
        customSecretLicenseKey: global-license-key-field
    asserts:
      - equal:
          path: data.license_key
          value: dGVzdC1rZXk=  # base64 encoded "test-key"
        template: templates/secret.yaml

  - it: customSecretLicenseKey - should use local customSecretLicenseKey over global.customSecretLicenseKey when both are set
    set:
      cluster: test
      licenseKey: test-key
      customSecretLicenseKey: local-license-key-field
      global:
        customSecretLicenseKey: global-license-key-field
    asserts:
      - equal:
          path: data.license_key
          value: dGVzdC1rZXk=  # base64 encoded "test-key"
        template: templates/secret.yaml

  # =============================================================================
  # CUSTOM ATTRIBUTES - Explicit Global Value Tests
  # =============================================================================
  - it: customAttributes - should inherit global.customAttributes when no local customAttributes are set
    set:
      cluster: test
      licenseKey: test-key
      global:
        customAttributes:
          environment: production
          team: platform
    asserts:
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'environment.*production'
        template: templates/kubelet/agent-configmap.yaml
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'team.*platform'
        template: templates/kubelet/agent-configmap.yaml

  - it: customAttributes - should use local customAttributes over global.customAttributes when both are set
    set:
      cluster: test
      licenseKey: test-key
      customAttributes:
        environment: staging
        region: us-east-1
      global:
        customAttributes:
          environment: production
          team: platform
    asserts:
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'environment.*staging'
        template: templates/kubelet/agent-configmap.yaml
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'region.*us-east-1'
        template: templates/kubelet/agent-configmap.yaml

  - it: customAttributes - should merge local and global customAttributes when both are set
    set:
      cluster: test
      licenseKey: test-key
      customAttributes:
        environment: staging
      global:
        customAttributes:
          team: platform
    asserts:
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'environment.*staging'
        template: templates/kubelet/agent-configmap.yaml
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'team.*platform'
        template: templates/kubelet/agent-configmap.yaml

  # =============================================================================
  # PROXY - Explicit Global Value Tests
  # =============================================================================
  - it: proxy - should inherit global.proxy when no local proxy is set
    set:
      cluster: test
      licenseKey: test-key
      global:
        proxy: https://proxy.example.com:8080
    asserts:
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'proxy.*https://proxy\.example\.com:8080'
        template: templates/kubelet/agent-configmap.yaml

  - it: proxy - should use local proxy over global.proxy when both are set
    set:
      cluster: test
      licenseKey: test-key
      proxy: https://local-proxy.example.com:3128
      global:
        proxy: https://global-proxy.example.com:8080
    asserts:
      - matchRegex:
          path: data.newrelic-infra\.yml
          pattern: 'proxy.*https://local-proxy\.example\.com:3128'
        template: templates/kubelet/agent-configmap.yaml

  # =============================================================================
  # VERBOSE LOG - Explicit Global Value Tests
  # =============================================================================
  - it: verboseLog - should inherit global.verboseLog when no local verboseLog is set
    set:
      cluster: test
      licenseKey: test-key
      global:
        verboseLog: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NRI_KUBERNETES_VERBOSE
            value: "true"
        template: templates/kubelet/daemonset.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NRI_KUBERNETES_VERBOSE
            value: "true"
        template: templates/ksm/deployment.yaml

  - it: verboseLog - should use local verboseLog over global.verboseLog when both are set
    set:
      cluster: test
      licenseKey: test-key
      verboseLog: false
      global:
        verboseLog: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NRI_KUBERNETES_VERBOSE
            value: "false"
        template: templates/kubelet/daemonset.yaml

  - it: verboseLog - should default to false when neither global nor local is set
    set:
      cluster: test
      licenseKey: test-key
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NRI_KUBERNETES_VERBOSE
            value: "false"
        template: templates/kubelet/daemonset.yaml

  # =============================================================================
  # FARGATE - Explicit Global Value Tests (from _helpers.tpl)
  # =============================================================================
  - it: fargate - should inherit global.fargate when no local fargate is set
    set:
      cluster: test
      licenseKey: test-key
      global:
        fargate: true
    asserts:
      # When fargate is enabled, kubelet daemonset should not be created
      - hasDocuments:
          count: 0
        template: templates/kubelet/daemonset.yaml

  - it: fargate - should use local fargate over global.fargate when both are set
    set:
      cluster: test
      licenseKey: test-key
      fargate: false
      global:
        fargate: true
    asserts:
      # When local fargate is false, kubelet daemonset should be created
      - hasDocuments:
          count: 1
        template: templates/kubelet/daemonset.yaml

  # =============================================================================
  # COMPREHENSIVE PRECEDENCE VALIDATION
  # =============================================================================
  - it: comprehensive precedence test - all global values should be overridden by local values
    set:
      # Local values that should override global
      cluster: local-cluster
      licenseKey: local-license-key
      customSecretName: local-secret
      customSecretLicenseKey: local-key-field
      customAttributes:
        environment: local-env
      proxy: https://local-proxy.com:8080
      verboseLog: false
      fargate: false
      labels:
        app: local-app
      podLabels:
        version: local-v1
      priorityClassName: local-priority
      hostNetwork: false
      podSecurityContext:
        fsGroup: 2000
      containerSecurityContext:
        runAsUser: 2000
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      # Global values that should be overridden
      global:
        cluster: global-cluster
        licenseKey: global-license-key
        customSecretName: global-secret
        customSecretLicenseKey: global-key-field
        customAttributes:
          environment: global-env
        proxy: https://global-proxy.com:8080
        verboseLog: true
        fargate: true
        labels:
          app: global-app
        podLabels:
          version: global-v1
        priorityClassName: global-priority
        hostNetwork: true
        podSecurityContext:
          fsGroup: 1000
        containerSecurityContext:
          runAsUser: 1000
        dnsConfig:
          options:
            - name: ndots
              value: "2"
    asserts:
      # Verify local values are used over global values
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CLUSTER_NAME
            value: local-cluster
        template: templates/kubelet/daemonset.yaml
      - equal:
          path: data.license_key
          value: bG9jYWwtbGljZW5zZS1rZXk=  # base64 encoded "local-license-key"
        template: templates/secret.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NRI_KUBERNETES_VERBOSE
            value: "false"
        template: templates/kubelet/daemonset.yaml
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 2000
        template: templates/kubelet/daemonset.yaml
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 2000
        template: templates/kubelet/daemonset.yaml
      - equal:
          path: metadata.labels.app
          value: local-app
        template: templates/secret.yaml
      - equal:
          path: spec.template.metadata.labels.version
          value: local-v1
        template: templates/kubelet/daemonset.yaml
